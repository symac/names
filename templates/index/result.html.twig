{% extends 'base.html.twig' %}

{% block title %}APF - Anagram Pseudo Finder{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/result.css') }}"/>
{% endblock %}

{% block css %}

    {% if not result.finished %}
        #share {
        display:none;
        }

        #filter {
        display:none;
        }
    {% endif %}
{% endblock %}

{% block javascripts %}
    <script type="text/javascript">
        var totalNumFound = 0;

        var ready = (callback) => {
            if (document.readyState != "loading") callback();
            else document.addEventListener("DOMContentLoaded", callback);
        }


        function callJson() {
            fetch("{{ url("ajax_result", {'name': result.search}) }}")
                .then(function (response) {
                    var contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        return response.json().then(function (json) {
                            let progressBar = document.getElementById("barStatus");
                            progressBar.style.width = json.percent + '%';

                            if (json.status == 2) {
                                document.querySelector("#progressBar").style.display = "none";
                                document.querySelector("#numFound").innerHTML = totalNumFound + " anagrams found : <strong>finished âœ”</strong> (<a href='{{ url('permalink', {name: result.searchSlugified, id: result.id}) }}'>sort alphabetically</a>)";
                                document.querySelector("#share").style.display = "block";
                                document.querySelector("#filter").style.display = "block";
                                document.querySelector("#loader").style.display = "none";
                            } else if (json.status == 1) {
                                for (let i = 0; i < json.results.length; i++) {
                                    let element = document.createElement("li");
                                    element.textContent = json.results[i]['s'] + " " + json.results[i]['f'];
                                    element.className = "gender" + json.results[i]["g"];
                                    element.classList.add("gender");
                                    document.querySelector("#resultList").appendChild(element);
                                }
                                totalNumFound += json.results.length;
                                document.querySelector("#numFound").textContent = totalNumFound + " found";
                                callJson();
                            } else {
                                console.log("Autre statut");
                                console.log(json);
                            }
                        });
                    }
                    console.log(contentType);
                }).catch(error => {
                alert("KO");
            });
        }

        function filterResults(buttonId) {
            buttonId = buttonId.replace("btnFilter", "");
            for (i = 1; i <= 2; i++) {
                if (i == parseInt(buttonId)) {
                    document.querySelectorAll(".gender" + i).forEach(a => a.style.display = "block");
                } else {
                    document.querySelectorAll(".gender" + i).forEach(a => a.style.display = "none");
                }
            }
        }

        ready(() => {
            {% if not result.finished %}
           callJson();
            {% endif %}
            document.addEventListener('click', function (event) {
                if ((event.target.id == "btnFilter0") || (event.target.id == "btnFilter1") || (event.target.id == "btnFilter2")) {
                    filterResults(event.target.id);
                }
            }, false);

        });
    </script>

{% endblock %}

{% block body %}
    {% if result.finished %}
        <h2>{{ result.countAnagrams }} anagrams found for : {{ result.search }}</h2>
    {% else %}
        <h2>Search anagrams for : {{ result.search }}</h2>
    {% endif %}
    <div id="share">Share this result : <a
                href="{{ url("permalink", {name: result.searchSlugified, id: result.id}) }}">{{ url("permalink", {name: result.searchSlugified, id: result.id}) }}</a>
    </div>
    <div id="filter">
        <p>Limit to :
            <button class="btnFilter" id='btnFilter1'>Female, unisex & unknown</button>
            <button class="btnFilter" id='btnFilter2'>Male, unisex & unknown</button>
        </p>
    </div>
    {% if result.finished %}

        <div id="resultDiv">
            <ul id="resultList">
                {% for anagram in result.getSortedAnagrams %}
                    <li class="gender gender{{ anagram.g }}">{{ anagram.s }} {{ anagram.f }}</li>
                {% endfor %}
            </ul>
        </div>
    {% else %}
        <div id="loader">Loading...</div>
        <p id="numFound"></p>
        <div id="progressBar">
            <div id="barStatus"></div>
        </div>
        <div id="resultDiv">
            <ul id="resultList">
            </ul>
        </div>
    {% endif %}
{% endblock %}
